---
title: 03 中间人攻击与HTTPS
date: 2021-2-22
categories:
 - 浏览器
tags:
 - 浏览器安全
---



## 中间人攻击

当用户发送 HTTP 请求时，传输的内容会经过用户电脑、WiFi 路由器、运营商和目标服务器，在响应 HTTP 请求也会经历这些环节，而在这每个环节中，由于 HTTP 明文传输的特性，**数据都有可能被中间人所窃取、伪造或篡改**，这种攻击方式就是中间人攻击。

由于 HTTP 明文传输的特性使得传输过程毫无安全性可言，而为了防范这种攻击方式，就需要一种加密方案，即 **HTTPS**。

HTTPS 并不是一个新的协议，其原理是在 HTTP 与 TCP 之间新加入一个安全层（SSL/TLS）。也就是在传输数据阶段，HTTP 数据会先经过安全层，然后安全层再将数据传输到 TCP 层。

HTTPS 所有的安全核心都在安全层，它负责**对发起 HTTP 请求的数据进行加密操作**和**对接收到的 HTTP 响应内容进行解密操作**。



## 加密方式

对数据的加密与解密方式有三种：对称加密、非对称加密以及混合加密

### 对称加密

对称加密指的是**加密和解密使用的密钥都是同一个**，是对称的。发送端在传输数据前使用对称密钥对明文加密后再传输，接收端接收到数据时使用对称密钥进行解密就能拿到明文数据。若黑客对数据进行窃取，窃取到的数据也是加密后的数据。

但是对称密钥的协商是一个问题，在协商的过程中对称密钥有可能会被黑客所获取，后续传输的密文也能够被黑客解密。

### 非对称加密

非对称加密也叫公钥加密算法。这种加密方式使用了两种密钥：**公钥**和**私钥**。公钥是公开的，而私钥是严格保存的

非对称加密能够解决密钥协商的问题。网站保管好私钥，在网上任意分发公钥，在传输数据阶段时，发送端利用公钥加密，接收端使用私钥对密文进行解密便能够得到明文。若黑客同时窃取了公钥和密文，由于没有私钥，也就无法解密。

但是由于非对称加密算法十分复杂，非对称加密的算法时间性能比较差。如果在传输阶段使用非对称加密，那么性能便会有很大的问题。

### 混合加密

混合加密能够很好地解决对称加密和非对称加密产生的问题，指的是同时使用上面两种加密方式。

混合加密的实现方式主要过程如下：

+ 针对密钥协商阶段，使用**非对称加密的方式来协商出后续传输阶段所需的密钥**。即发送端利用公钥加密会话密钥后发送给接收端，接收端利用私钥解密得到会话密钥，这样一来双方都拥有了会话密钥。
+ 针对数据传输阶段，**使用对称加密的方式来加密明文**。即对明文直接使用会话密钥加密后传输。

HTTPS 采用的也是这种加密方式。



## 数字证书与CA

通过对称加密和非对称加密的混合方式，能够完美地实现数据的加密传输，即实现机密性。不过由 CIA 我们得知还有完整性没有实现，比如黑客通过 DNS 劫持将服务端的 IP 地址替换成黑客的 IP 地址，这样一来我们访问到的其实是黑客的服务器，黑客就可以自己实现公钥和私钥，从而让浏览器认为是安全的。

那么我们如何实现完整性呢？即如何证明我们访问到的服务器就是我们要访问的服务器呢？

这就需要使用到数字证书，可以把数字证书想象成房产证，能够证明用户的身份。而对于数字证书的颁发机构就是 **CA，即数字证书认证机构**，可以把 CA 机构想象成房地产商，为用户颁发能够证明用户身份的证书。

**数字证书**中主要含有下面这些东西：

+ **服务器的公钥**
+ 证书的基础信息，包括证书序列号、颁发者、有效时间、签名算法等
+ CA 机构的数字签名（用于验证证书的真伪）



## TLS 的握手过程

TLS 也有握手过程来确定服务器的真伪以及确认双方使用的会话密钥，具体的握手流程如下（加密套件指的是加密的算法）：

<img src="@img/image-20210226143555245.png" alt="image-20210226143555245" style="zoom:80%;" />

可以看出实现完整性的最重要的流程就是验证数字证书，而实现机密性是利用公钥来协商出会话密钥。



## 如何验证数字证书

首先我们需要了解数字证书是如何生成的：

1. 服务器用户将**公钥以及自己的资料信息**交给 CA 机构
2. CA 机构通过各种渠道验证服务器的真实性
3. CA 机构将基础信息和服务器公钥一起进行 Hash 生成**信息摘要**，再利用 **CA 机构的私钥**对信息摘要进行加密生成**数字签名**。
4. 将数字签名、基础信息和服务器公钥一起放进数字证书中

那么如何验证数字证书的真伪：

1. 浏览器利用**CA 机构的公钥**对数字签名进行解密得到信息摘要
2. 浏览器再将基础信息和服务器公钥一起进行 Hash（签名算法在数字证书中） 后又生成一份信息摘要
3. 这两份信息摘要进行比对是否是同一份便可知道数字证书的真伪

这时候又产生一个新的问题，CA 机构的公钥从哪来？**CA 机构的公钥在 CA 机构的数字证书中**，那 CA 机构的数字证书从哪来？CA 机构的证书一般是通过下载得到或内置在操作系统中（根证书就在操作系统中），这样一来又得验证 CA 机构数字证书的真伪。

而给 CA 机构颁发数字证书的上级 CA 机构我们也得验证，直到验证到根 CA 机构。

我们可以打开浏览器 URL 地址栏左边的小锁就可以看到数字证书的信息以及 CA 机构的数字证书。以力扣官网为例，其数字证书的 CA 机构有两家，最上级的便是根 CA 机构。

<img src="@img/image-20210226150415139.png" alt="image-20210226150415139" style="zoom:80%;" />