---
title: 04 TCP拥塞控制
date: 2021-03-23
categories:
 - 网络协议
tags:
 - TCP
---



## 拥塞控制

我们知道，在数据的传输过程的一整条数据链路中会经过非常多的设备，例如路由，交换机等等。而这当中的某些结点就有可能由于缓存容量太小而无法存储该数据报文，不得不丢弃，当这种情况的发生，便会使网络的性能变坏，这就叫做拥塞，即网络中某一资源的需求超过了该资源所能提供的可用部分。

所谓的拥塞控制就是**防止过多的数据注入网络中，这样可以使网络中的某些设备不至于过载**，这是一个全局性的过程，涉及到所有的主机所有的路由器。

拥塞控制和流量控制的区别：

+ 流量控制考虑点对点的通信量的控制，抑制发送端发送数据的速率，以便接收方来得及接收

+ 拥塞控制考虑整个网络，是全局性的考虑



## 拥塞窗口

拥塞控制的实现是基于**拥塞窗口 cwnd** 的，发送方会维持一个拥塞窗口的状态变量，它的大小取决于网络的拥塞程度。

发送方控制拥塞窗口的原则是：只要网络没有出现拥塞（超时），拥塞窗口就可以再增大，以便更多数据发送出去，这样就可以提高网络的利用率。但只要网络出现拥塞，就把拥塞窗口减小，以减少数据注入到网络中，缓解网络出现的拥塞。

另外我们需要与上文提到的流量控制实现的**接收窗口 rwnd** 做区分，它们是两个不同的状态变量

+ 接收窗口是接收端给的限制
+ 拥塞窗口是发送端给的限制

cwnd 和 rwnd 都参与发送方窗口大小的限制

```
发送方窗口大小 = min(cwnd, rwnd)
```




## 拥塞控制算法

TCP 进行拥塞控制的算法有四种

+ 慢启动
+ 拥塞避免
+ 快速重传
+ 快速恢复



### 慢启动

慢启动算法的思路是：当主机开始发送数据时，由于不清楚网络的负荷情况，所以如果立即把大量数据字节注入到网络，那么就有可能出现网络拥塞。所以最好的方法是先探测一下，即**由小到大逐渐增大发送窗口**，也就是逐渐增大 cwnd 的值。

在一开始发送方先设置 cwnd=1，发送第一个报文段，接收方收到后确认。发送方接收到确认后把 cwnd 增大到2，于是发送方发送两个报文段，接收方收到后发回两个确认。发送方接收到确认后把 cwnd 增大到4。。。。如此进行下去逐渐增大拥塞窗口

<img src="@img/image-20210323120849478.png" alt="image-20210323120849478" style="zoom:80%;" />

可以看出发送方**每收到一个对新报文段的确认就让发送方的拥塞窗口加一**，也就是说，每经过一个**传输轮次**拥塞窗口 cwnd 就加倍。一个传输轮次的时间就是往返时间 RTT。



### 拥塞避免

由于慢启动算法增长拥塞窗口是指数级的，所以为了防止拥塞窗口增长过大而引起网络拥塞，还需要设置一个**慢启动阈值 ssthresh** 状态变量。其中

+ 当 cwnd < ssthresh 时，使用慢启动算法
+ 当 cwnd > ssthresh 时，使用拥塞避免算法
+ 当 cwnd = ssthresh 时，既能使用慢启动算法，也能使用拥塞避免算法

拥塞避免算法的思路是：让拥塞窗口缓慢增长，**每经过一个往返 RTT 就把发送方的拥塞窗口 cwnd 加一**，这种按线性规律的增长就比慢启动加倍增长的速率缓慢得多了，使网络比较不容易出现拥塞。

另外，当网络中出现拥塞（超时）时，发送方便会有如下调整

1. 设置 ssthresh = cwnd/2
2. 同时设置 **cwnd=1**
3. 重新进入**慢启动阶段**。

有时个别报文段会在网络中丢失，但是实际上网络并没有发生拥塞。如果发送方迟迟没有收到确认，就会产生超时，便会误认为网络出现拥塞，从而重新进入慢启动阶段，把拥塞窗口设置为1，降低了传输效率。

为了尽量避免上面情况的出现，就需要采用**快速重传算法**和**快速恢复算法**



### 快速重传

采用快速重传算法可以让**发送方尽早知道发生了个别报文段的丢失**。

快速重传算法的思路是：即使接收方收到了**失序的报文段**也要立即发出对已收到的报文段的重复确认，发送方只要**连续收到3个重复确认**，就立即进行重传，这样就不会出现超时，发送方也就不会误认为出现网络拥塞。

<img src="@img/image-20210323134246999.png" alt="image-20210323134246999" style="zoom:80%;" />

例如上面这个例子，在传输 M3 时发生了丢失，当接收方收到 M4、M5 和 M6 时都重复确认 M2，这样发送方收到3个重复确认就会认为接收方确实没有收到 M3，传输过程中发生了丢失，便立即重传 M3。



### 快速恢复

当发送方连续收到3个重复确认时，就知道丢失了个别的报文段，于是不启用慢启动算法，而是执行快速恢复算法。

1. 发送方会调整 ssthresh = cwnd/2
2. 同时设置拥塞窗口 **cwnd = ssthresh**
3. 开始执行**拥塞避免算法**