---
title: 06 TCP四次挥手
date: 2021-03-25
categories:
 - 网络协议
tags:
 - TCP
---



## TCP 四次挥手

在数据传输结束后，通信双方都可以释放连接，释放连接通过四次挥手。比三次握手多增加一步是由于**服务器可能会有尚未处理完成的请求需要发出**。

以下是四次挥手的具体过程

<img src="@img/image-20210314223914494.png" alt="image-20210314223914494" style="zoom:80%;" />

+ 数据传送结束，当前 A 和 B 都处于 ESTABLISHED 状态。
+ A 主动关闭连接，向 B 发送一个连接释放报文，其终止位 FIN=1 且序号 seq=u，这时 A 进入 FIN-WAIT-1（终止等待1）状态
+ B 收到连接释放报文后发送确认报文，其确认号 ack=u+1，序号为 v，这时 B 进入 CLOSE-WAIT（关闭等待）状态
+ 当 A 收到 B 的确认后进入 FIN-WAIT-2（终止等待2）状态。由于 B 中可能还会有请求需要发出，所以双方都在等待
+ 若 B 已经没有请求需要发出了，那么 B 会向 A 发出连接释放报文，其终止位 FIN=1，还必须重复上次已经发送过的确认号 ack=u+1，以及 B 当前的序号 seq=w（w 是最后一份数据序号+1），这时 B 进入 LAST-ACK（最后确认）状态
+ A 收到 B 的连接释放报文后，发出确认，其确认号 ack=w+1 以及序号 seq = u+1，这时 A 进入 TIME-WAIT（时间等待）状态
+ B 收到 A 的确认后便释放连接，进入 CLOSED 状态
+ A 在发出确认后需要经过**时间等待计时器**设置的 **2MSL**（2倍的**最长报文段寿命**，一般是4分钟）时间后才能进入 CLOSED 状态



## 为什么 A 需要等待 2MSL 的时间呢

主要有两个原因

1. **为了保证 A 发送的最后一个 ACK 报文能够到达 B**。这个 ACK 有可能会丢失，因此若 B 收不到确认，那么会超时重传 FIN+ACK 报文，而 A 就能在 2MSL 的时间内收到这个重传的报文。接着 A 再重传一次确认，重新启动计时器。若 A 在 2MSL 没有收到 B 重传报文，则证明 B 已经收到 A 的 ACK，那么 A 就可以进入 CLOSED 状态了
2. 防止已失效连接请求报文段出现在本连接中。A 在发送完最后一个 ACK 后经过 2MSL，就可以使本连接中产生的所有报文段都从网络中消失，若有滞留在网络中的请求连接报文也会消失。