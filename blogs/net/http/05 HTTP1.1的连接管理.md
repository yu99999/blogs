---
title: 05 HTTP1.1的连接管理
date: 2021-03-14
categories:
 - 网络协议
tags:
 - HTTP
---



## 短连接

在早期的 HTTP 协议（0.9/1.0）中，由于 HTTP 底层的数据传输基于 TCP/IP，每次发送请求前需要与服务器建立连接，收到报文后会立即关闭连接，这种连接状态被称为**短连接**。

TCP 建立连接需要三次握手，即发送3个数据包，需要1个RTT；TCP 断开连接需要四次挥手，即发送4个数据包，需要2个RTT。而 HTTP 的一次简单请求响应通常只需要4个数据包，即2个RTT。由此可见，短连接的缺点对性能的影响相当严重。



## 长连接

针对短连接暴露出来的缺点，HTTP 协议提出了**长连接**。 启用长连接后，只要向服务器发送第一次请求，后续的请求都会复用第一次打开的 TCP 连接。启用长连接的方法也很简单，只要在响应报文放一个字段即可

```
Connection: keep-alive
```

现在服务器默认会开启长连接



## 如何解决队头阻塞

由于 HTTP 的请求-应答模型，所有的请求形成了一个队列，队头的请求最先被处理，如果处理的时间过长会导致队列后面的请求都会被阻塞，从而客户端接收不到响应，这便是队头阻塞。

队头阻塞导致的性能问题，在 HTTP1.1 里无法解决，只能缓解，那么有什么办法呢？

### 并发连接

对一个域名发起多个长连接，也就是增加请求队列的数量，不至于一个请求便阻塞了其他请求。

RFC2616规定每个客户端最多并发2个连接，但是2个连接实在太少了，所以现在众多浏览器都把长连接的并发数量提高到6~8个。Chrome 是6个。

### 域名分片

一个域名能够并发6个长连接，那么我们多分几个域名，本质上还是增加了请求队列的数量。

例如多增加几个域名，并且让这些域名都指向同一台服务器，这样长连接的数量边上去了。